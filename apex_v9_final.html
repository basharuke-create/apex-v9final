<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0">
<title>APEX Î© v8.0</title>
<link href="https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Orbitron:wght@400;700;900&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.0/dist/chart.umd.min.js"></script>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#040407;--card:#0b0b14;--border:#1a1a2e;
  --g:#00ffaa;--p:#9d5cf5;--r:#ff5533;--y:#f5c400;
  --dim:#2e2e50;--txt:#c0c8e0;--txt2:#505078;
}
html{scroll-behavior:smooth}
body{background:var(--bg);color:var(--txt);font-family:'Share Tech Mono',monospace;min-height:100vh}

/* â”€â”€ STICKY HEADER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#hdr{
  position:sticky;top:0;z-index:200;height:50px;
  background:rgba(4,4,7,.97);border-bottom:1px solid var(--border);
  backdrop-filter:blur(12px);
  display:flex;align-items:center;gap:12px;padding:0 16px;
}
#logo{
  font-family:'Orbitron',sans-serif;font-size:15px;font-weight:900;
  color:var(--g);letter-spacing:4px;white-space:nowrap;flex-shrink:0;
}
/* progress bar under header */
#progress-bar{
  position:sticky;top:50px;z-index:199;height:3px;
  background:var(--border);
}
#progress-fill{
  height:3px;background:linear-gradient(90deg,var(--g),var(--p));
  width:0%;transition:width .6s ease;
}

/* phase steps scroll */
#phase-bar{display:flex;flex:1;overflow-x:auto;scrollbar-width:none}
#phase-bar::-webkit-scrollbar{display:none}
.ph{
  padding:0 10px;height:50px;display:flex;align-items:center;
  font-size:9px;letter-spacing:1px;color:var(--dim);
  border-bottom:2px solid transparent;transition:.3s;
  white-space:nowrap;flex-shrink:0;gap:5px;
}
.ph.active{color:var(--g);border-color:var(--g);background:rgba(0,255,170,.04)}
.ph.done{color:var(--p);border-color:var(--p)}
.ph.error{color:var(--r);border-color:var(--r)}
.ph-ck{display:none}
.ph.done .ph-ck{display:inline}
#glob-dot{
  width:8px;height:8px;border-radius:50%;
  background:var(--dim);flex-shrink:0;transition:.4s;
}
#glob-dot.run{background:var(--g);box-shadow:0 0 10px var(--g);animation:pulse 1s infinite}
#glob-dot.ok{background:var(--p)}
#glob-dot.err{background:var(--r)}
@keyframes pulse{50%{opacity:.3}}

/* â”€â”€ LAYOUT â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#wrap{max-width:820px;margin:0 auto;padding:20px 16px 100px}

/* â”€â”€ INPUT PANEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
#inp-panel{
  background:var(--card);border:1px solid var(--border);
  border-radius:8px;padding:18px;margin-bottom:20px;
}
.lbl{font-size:9px;letter-spacing:2px;color:var(--g);margin-bottom:6px;display:block}
.irow{display:flex;gap:8px;margin-bottom:12px}
.inp{
  background:#000;color:var(--g);
  border:1px solid var(--border);
  padding:10px 12px;border-radius:4px;outline:none;
  font-family:'Share Tech Mono',monospace;font-size:13px;
  width:100%;transition:.3s;
}
.inp:focus{border-color:var(--g)}
textarea.inp{resize:vertical;min-height:90px}
.btn{
  background:transparent;border:1px solid var(--g);color:var(--g);
  padding:10px 18px;border-radius:4px;cursor:pointer;
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:2px;transition:.25s;white-space:nowrap;
}
.btn:hover:not(:disabled){background:var(--g);color:#000;box-shadow:0 0 18px var(--g)50}
.btn:disabled{opacity:.3;cursor:not-allowed}
.btn.s{border-color:var(--p);color:var(--p)}
.btn.s:hover:not(:disabled){background:var(--p);color:#fff}
.btn.d{border-color:var(--dim);color:var(--dim)}
.btn-row{display:flex;gap:8px;flex-wrap:wrap;margin-top:12px}

/* status bar */
#status-bar{
  display:none;margin-top:10px;padding:10px 14px;
  border-radius:4px;font-size:11px;line-height:1.7;
}
#status-bar.info{background:rgba(0,255,170,.06);border:1px solid var(--g);color:var(--g)}
#status-bar.err{background:rgba(255,85,51,.06);border:1px solid var(--r);color:var(--r)}
#status-bar.warn{background:rgba(245,196,0,.06);border:1px solid var(--y);color:var(--y)}

/* countdown */
#countdown{
  display:none;align-items:center;gap:10px;
  margin-top:10px;padding:10px 14px;
  border:1px solid var(--border);border-radius:4px;
  font-size:12px;color:var(--txt2);
}
#countdown.show{display:flex}
#cd-num{
  font-family:'Orbitron',sans-serif;font-size:20px;font-weight:700;
  color:var(--y);min-width:30px;text-align:center;
}
#cd-bar-track{flex:1;background:var(--border);border-radius:2px;height:4px;overflow:hidden}
#cd-bar-fill{height:4px;background:var(--y);transition:width .95s linear}

/* help text */
.help{font-size:10px;color:var(--txt2);margin-top:10px;line-height:1.9}
.help a{color:var(--g);text-decoration:none}

/* â”€â”€ CARDS â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.card{
  background:var(--card);border:1px solid var(--border);
  border-radius:8px;margin-bottom:14px;overflow:hidden;
  animation:slideUp .35s ease;
}
@keyframes slideUp{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:translateY(0)}}
.card-hdr{
  display:flex;align-items:center;gap:10px;
  padding:10px 16px;background:rgba(0,0,0,.35);
  border-bottom:1px solid var(--border);
}
.card-num{
  font-size:8px;letter-spacing:2px;color:var(--p);
  border:1px solid var(--p)50;padding:2px 7px;border-radius:2px;
}
.card-title{font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;letter-spacing:2px}
.card-body{padding:16px;font-size:12px;line-height:1.9}

/* retry button in card header */
.retry-btn{
  margin-left:auto;font-size:9px;padding:3px 10px;
  border:1px solid var(--r);color:var(--r);background:transparent;
  border-radius:2px;cursor:pointer;font-family:'Share Tech Mono',monospace;
  transition:.2s;
}
.retry-btn:hover{background:var(--r);color:#fff}

/* loading */
.ld{color:var(--p)}
.dots::after{content:'';animation:d 1.3s infinite}
@keyframes d{0%{content:''}33%{content:'.'}66%{content:'..'}100%{content:'...'}}

/* â”€â”€ PHASE 1 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.gbox{border:1px solid var(--border);border-radius:4px;padding:12px;margin-bottom:8px}
.gbox.sel{border-color:var(--g);background:rgba(0,255,170,.04)}
.g-lbl{font-size:8px;letter-spacing:2px;color:var(--txt2);margin-bottom:3px}
.g-goal{color:var(--g);margin-bottom:4px}
.g-why{font-size:11px;color:var(--txt2)}
.constraint-list{margin-top:12px;font-size:10px;color:var(--txt2)}
.constraint-list span{color:var(--r);margin-right:10px}

/* â”€â”€ PHASE 2 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.layer{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
.l-type{
  font-size:8px;padding:3px 7px;border-radius:2px;
  white-space:nowrap;flex-shrink:0;margin-top:2px;
}
.l-q{font-size:10px;color:var(--txt2);margin-bottom:2px}
.l-a{font-size:12px}
.bottleneck{
  border:1px solid var(--p)60;border-radius:4px;
  background:rgba(157,92,245,.05);padding:12px;margin-top:12px;
}
.b-lbl{font-size:8px;letter-spacing:2px;color:var(--p);margin-bottom:5px}

/* â”€â”€ PHASE 3 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.s-card{
  border:1px solid var(--border);border-radius:4px;
  padding:14px;margin-bottom:10px;
}
.s-id{font-size:8px;letter-spacing:2px;margin-bottom:4px}
.s-name{font-family:'Orbitron',sans-serif;font-size:12px;font-weight:700;margin-bottom:8px}
.s-desc{font-size:11px;color:var(--txt2);line-height:1.8;margin-bottom:8px}
.s-meta{font-size:10px;color:var(--dim)}

/* â”€â”€ PHASE 4 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.ax-row{margin-bottom:13px}
.ax-head{display:flex;justify-content:space-between;font-size:11px;margin-bottom:5px}
.ax-vals{display:flex;gap:8px}
.av{font-weight:700;cursor:help;position:relative}
.bars{display:flex;flex-direction:column;gap:3px}
.bt{background:#080810;border-radius:2px;height:6px;overflow:hidden}
.bf{height:6px;border-radius:2px;width:0;transition:width 1.3s cubic-bezier(.4,0,.2,1)}
.totals{display:grid;grid-template-columns:repeat(3,1fr);gap:8px;margin-top:16px}
.tc{border:1px solid var(--border);border-radius:4px;padding:12px;text-align:center}
.tc.win{border-color:var(--p);box-shadow:0 0 20px var(--p)15}
.t-big{font-family:'Orbitron',sans-serif;font-size:30px;font-weight:900;line-height:1}
.t-sub{font-size:9px;color:var(--txt2);letter-spacing:1px;margin-top:4px}
.t-prob{font-size:10px;color:var(--txt2);margin-top:5px}
.chart-wrap{border:1px solid var(--border);border-radius:4px;padding:14px;margin-top:14px}

/* â”€â”€ PHASE 5 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.d-head{
  font-family:'Orbitron',sans-serif;font-size:10px;font-weight:700;
  letter-spacing:2px;color:var(--r);margin-bottom:12px;
}
.d-atk{border-left:2px solid var(--r);padding:8px 12px;margin-bottom:8px}
.d-angle{font-size:8px;color:var(--r);letter-spacing:2px;margin-bottom:3px}
.d-txt{font-size:12px;color:var(--txt2)}
.fatal{border:1px solid var(--r);border-radius:4px;background:rgba(255,85,51,.05);padding:12px;margin-top:12px}
.fatal-lbl{font-size:8px;color:var(--r);letter-spacing:2px;margin-bottom:4px}
.fatal-txt{color:var(--r);font-size:12px}

/* â”€â”€ PHASE 7 â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.v-box{border:1px solid var(--g);border-radius:8px;background:rgba(0,255,170,.03);padding:22px;text-align:center}
.v-circle{
  width:100px;height:100px;border-radius:50%;border:2px solid var(--g);
  margin:0 auto 18px;display:flex;flex-direction:column;align-items:center;justify-content:center;
  background:rgba(0,255,170,.06);box-shadow:0 0 40px var(--g)20;
}
.v-num{font-family:'Orbitron',sans-serif;font-size:30px;font-weight:900;color:var(--g)}
.v-sub{font-size:8px;color:var(--txt2);letter-spacing:2px}
.v-txt{font-family:'Orbitron',sans-serif;font-size:14px;font-weight:700;color:var(--g);line-height:1.6;margin-bottom:18px}
.v-reasons{text-align:left;margin-top:14px}
.v-reason{font-size:11px;color:var(--txt2);padding:5px 0;border-bottom:1px solid var(--border)}
.v-reason::before{content:'â†’ ';color:var(--g)}
.v-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px;text-align:left}
.v-mbox{border:1px solid var(--border);border-radius:4px;padding:12px}
.v-mlbl{font-size:8px;letter-spacing:2px;margin-bottom:5px}
.v-mtxt{font-size:11px}

/* â”€â”€ ERROR BOX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
.err-box{
  border:1px solid var(--r);border-radius:4px;
  background:rgba(255,85,51,.05);padding:14px;margin-bottom:10px;
}
.err-box summary{cursor:pointer;outline:none;color:var(--r);font-size:12px}
.err-detail{font-size:10px;color:var(--txt2);margin-top:8px;white-space:pre-wrap;word-break:break-all;background:#000;padding:10px;border-radius:2px}
.err-tips{font-size:11px;margin-top:8px;line-height:2;color:var(--txt2)}
.err-tips b{color:var(--y)}

/* â”€â”€ MISC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
::-webkit-scrollbar{width:3px}
::-webkit-scrollbar-thumb{background:var(--border)}
</style>
</head>
<body>

<!-- HEADER -->
<div id="hdr">
  <div id="logo">APEX Î©</div>
  <div id="phase-bar">
    <div class="ph" id="ph1">01Â·REFINE<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph2">02Â·DECOMPOSE<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph3">03Â·STRATEGIZE<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph4">04Â·SCORE<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph5">05Â·CHALLENGE<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph6">06Â·RE-EVAL<span class="ph-ck"> âœ“</span></div>
    <div class="ph" id="ph7">07Â·VERDICT<span class="ph-ck"> âœ“</span></div>
  </div>
  <div id="glob-dot"></div>
</div>
<div id="progress-bar"><div id="progress-fill"></div></div>

<div id="wrap">

  <!-- INPUT -->
  <div id="inp-panel">
    <div style="font-family:'Orbitron',sans-serif;font-size:9px;color:var(--p);letter-spacing:3px;margin-bottom:16px">
      APEX Î© v9.0 â€” AUTONOMOUS STRATEGIC INTELLIGENCE ENGINE
    </div>

    <label class="lbl">GEMINI API KEY</label>
    <div class="irow">
      <input class="inp" type="password" id="apiKey" placeholder="AIzaSy...">
      <button class="btn s" onclick="testConn()" id="testBtn">TEST</button>
    </div>

    <label class="lbl">STRATEGIC PROBLEM</label>
    <textarea class="inp" id="prob" placeholder="ä¾‹: æ–°è¦SaaSã®å¸‚å ´å‚å…¥ã‚¿ã‚¤ãƒŸãƒ³ã‚°ã€‚ç«¶åˆ3ç¤¾ã‚ã‚Šã€è³‡æœ¬é‡‘500ä¸‡å††ã€ãƒãƒ¼ãƒ 3åã€‚6ãƒ¶æœˆä»¥å†…ã«åç›ŠåŒ–å¿…é ˆã€‚"></textarea>

    <div class="btn-row">
      <button class="btn" id="runBtn" onclick="runAPEX()">â–¶ ENGAGE APEX</button>
      <button class="btn d" onclick="clearAll()">âœ• CLEAR</button>
    </div>

    <div id="status-bar"></div>

    <div id="countdown">
      <span style="font-size:10px;color:var(--txt2)">NEXT PHASE IN</span>
      <span id="cd-num">--</span>
      <div id="cd-bar-track"><div id="cd-bar-fill" style="width:100%"></div></div>
    </div>

    <div class="help">
      APIã‚­ãƒ¼: <a href="https://aistudio.google.com/app/apikey" target="_blank">aistudio.google.com</a> â†’ Get API Key â†’ AIzaSy... ã‚’ã‚³ãƒ”ãƒ¼ï¼ˆç„¡æ–™ï¼‰<br>
      âš¡ v9.0: TESTã¯APIæ ã‚’æ¶ˆè²»ã—ãªã„ã€‚ENGAGEã—ãŸã‚‰å®Œèµ°ã¾ã§æ”¾ç½®ã§OKã€‚
    </div>
  </div>

  <!-- OUTPUT -->
  <div id="output"></div>
</div>

<script>
'use strict';

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONFIG
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const GEMINI_MODEL   = 'gemini-2.0-flash';
const CALL_GAP_MS    = 5500;  // 5.5ç§’å›ºå®šé–“éš” = æœ€å¤§10.9å›/åˆ† â†’ ç„¡æ–™æ 15å›/åˆ†ã«ç‰©ç†çš„ã«å±Šã‹ãªã„
const PHASE_GAP_MS   = 800;   // ãƒ•ã‚§ãƒ¼ã‚ºé–“ã®è¦–è¦šçš„ã‚®ãƒ£ãƒƒãƒ—ï¼ˆrate limitã¨ã¯åˆ¥ï¼‰
const WAIT_429_SEC   = 95;    // 429ç™ºç”Ÿæ™‚ã®å¾…æ©Ÿç§’æ•°ï¼ˆGeminiçª“ãƒªã‚»ãƒƒãƒˆã«90ç§’å¿…è¦ï¼‰

const W      = {strategic:.25, financial:.20, risk:.20, execution:.20, psychological:.15};
const COLORS = {A:'#00ffaa', B:'#9d5cf5', C:'#ff5533'};

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  STATE
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
let ST = {};
let chartInst   = null;
let isRunning   = false;
let lastCallAt  = 0;  // ãƒšãƒ¼ã‚¸å†…ã§ã®æœ€å¾Œã®ãƒªã‚¯ã‚¨ã‚¹ãƒˆæ™‚åˆ»

// â”€â”€ ã‚·ãƒ³ãƒ—ãƒ«ãªå›ºå®šé–“éš”ãƒ¬ãƒ¼ãƒˆåˆ¶å¾¡ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
// ãƒã‚¤ãƒ³ãƒˆ: reqLogã‚„ã‚¹ãƒ©ã‚¤ãƒ‡ã‚£ãƒ³ã‚°ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã¯ä½¿ã‚ãªã„ã€‚
// ã€Œå‰å›ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰5.5ç§’çµŒã£ã¦ã„ãªã‘ã‚Œã°å¾…ã¤ã€ã ã‘ã€‚
// ãƒšãƒ¼ã‚¸ãƒªãƒ­ãƒ¼ãƒ‰ã—ã¦ã‚‚ lastCallAt=0 â†’ æœ€åˆã¯å³å®Ÿè¡ŒOKã€‚
// å‰ã‚»ãƒƒã‚·ãƒ§ãƒ³ã®æ®‹ã‚Šã‚«ã‚¦ãƒ³ãƒˆã¯é–¢ä¿‚ãªãã€é–“éš”ã ã‘å®ˆã‚‹ã€‚
async function rateGate(label) {
  const gap = CALL_GAP_MS - (Date.now() - lastCallAt);
  if (gap > 0) {
    const sec = Math.ceil(gap / 1000);
    showStatus(`â³ ${label} â€” å¾…æ©Ÿä¸­ ${sec}ç§’ (Rate limitå¯¾ç­–)`, 'warn');
    const stop = startCountdown(sec);
    await sleep(gap);
    stop();
    hideStatus();
  }
  lastCallAt = Date.now();
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  DOM HELPERS
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
const $ = id => document.getElementById(id);
const esc = s => String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
const sleep = ms => new Promise(r => setTimeout(r, ms));

function setPhase(n, cls) {
  const el = $('ph'+n);
  if (el) el.className = 'ph '+(cls||'');
}

function setDot(cls) { $('glob-dot').className = cls; }

function setProgress(n) { // n = 0-7
  $('progress-fill').style.width = (n/7*100)+'%';
}

function showStatus(msg, type='info') {
  const s = $('status-bar');
  s.style.display = 'block';
  s.className = type;
  s.innerHTML = msg;
}
function hideStatus() { $('status-bar').style.display='none'; }

// Countdown timer display
function startCountdown(totalSec) {
  const cd = $('countdown');
  const numEl = $('cd-num');
  const fill = $('cd-bar-fill');
  cd.classList.add('show');
  let rem = totalSec;
  numEl.textContent = rem;
  fill.style.transition = 'none';
  fill.style.width = '100%';
  void fill.offsetWidth; // reflow
  fill.style.transition = `width ${totalSec}s linear`;
  fill.style.width = '0%';
  const iv = setInterval(() => {
    rem--;
    numEl.textContent = Math.max(0, rem);
    if (rem <= 0) clearInterval(iv);
  }, 1000);
  return () => { clearInterval(iv); cd.classList.remove('show'); };
}

function addCard(id, num, title, body, showRetry=false) {
  const out = $('output');
  let c = $(id);
  if (!c) { c = document.createElement('div'); c.id = id; c.className = 'card'; out.appendChild(c); }
  const retryHtml = showRetry
    ? `<button class="retry-btn" onclick="retryPhase(${num})">â†º RETRY</button>` : '';
  c.innerHTML = `
    <div class="card-hdr">
      <span class="card-num">PHASE ${String(num).padStart(2,'0')}</span>
      <span class="card-title">${title}</span>
      ${retryHtml}
    </div>
    <div class="card-body">${body}</div>`;
  setTimeout(() => c.scrollIntoView({behavior:'smooth', block:'nearest'}), 50);
}

function loadCard(id, num, title, msg) {
  addCard(id, num, title, `<div class="ld">// ${esc(msg)}<span class="dots"></span></div>`);
}

function showErrCard(id, num, phLabel, detail) {
  // Extract just the key message (first line, max 200 chars)
  const msg = String(detail).split('\n')[0].slice(0, 200);
  addCard(id, num, phLabel,
    `<div class="err-box">
      <div style="color:var(--r);font-size:12px;margin-bottom:8px">âš  ${esc(msg)}</div>
      <div style="font-size:10px;color:var(--txt2);background:#000;padding:8px;border-radius:2px;word-break:break-all">${esc(String(detail).slice(0,500))}</div>
    </div>
    <div class="err-tips" style="margin-top:10px">
      <b>å¯¾å‡¦æ³•ï¼š</b><br>
      1. APIã‚­ãƒ¼ç¢ºèª â†’ TESTãƒœã‚¿ãƒ³ã§æ¥ç¶šãƒ†ã‚¹ãƒˆ<br>
      2. Rate Limit â†’ â†ºRETRYã‚’æŠ¼ã™ï¼ˆè‡ªå‹•ã§å¾…æ©Ÿå¾Œã«å†å®Ÿè¡Œï¼‰<br>
      3. JSONå¤±æ•— â†’ â†ºRETRYã§å¤§æŠµç›´ã‚‹
    </div>`, true);
  setPhase(num, 'error');
}

function clearAll() {
  $('output').innerHTML = '';
  [1,2,3,4,5,6,7].forEach(n => setPhase(n,''));
  setDot(''); setProgress(0);
  ST = {};
  if (chartInst) { chartInst.destroy(); chartInst = null; }
  hideStatus();
  $('countdown').classList.remove('show');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  JSON REPAIR â€” 5æ®µéšãƒ‘ãƒ¼ã‚µãƒ¼
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function safeJSON(text) {
  if (!text) return null;

  // Stage 1: direct
  try { return JSON.parse(text); } catch(_) {}

  // Stage 2: strip markdown fences
  let t = text.replace(/^```json\s*/i,'').replace(/^```\s*/,'').replace(/\s*```\s*$/,'').trim();
  try { return JSON.parse(t); } catch(_) {}

  // Stage 3: extract {...} block
  const m = text.match(/\{[\s\S]*\}/);
  if (m) try { return JSON.parse(m[0]); } catch(_) {}

  // Stage 4: fix common LLM JSON mistakes
  let fixed = (m ? m[0] : t)
    .replace(/,\s*([}\]])/g, '$1')           // trailing commas
    .replace(/([{,]\s*)(\w+)\s*:/g, '$1"$2":')// unquoted keys
    .replace(/:\s*'([^']*)'/g, ':"$1"')      // single-quoted values
    .replace(/\n/g,' ');
  try { return JSON.parse(fixed); } catch(_) {}

  // Stage 5: log and fail
  console.warn('safeJSON: all stages failed. Raw:', text.slice(0, 400));
  return null;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  API CALL â€” å›ºå®šé–“éš”åˆ¶å¾¡ + 429è‡ªå‹•ãƒªã‚«ãƒãƒª
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function callGemini(system, user, phaseLabel='API') {
  const key = $('apiKey').value.trim();
  if (!key) throw new Error('APIã‚­ãƒ¼ãŒå…¥åŠ›ã•ã‚Œã¦ã„ã¾ã›ã‚“');

  // å‰ãƒªã‚¯ã‚¨ã‚¹ãƒˆã‹ã‚‰5.5ç§’æœªæº€ãªã‚‰å¾…æ©Ÿ
  await rateGate(phaseLabel);

  const url  = `https://generativelanguage.googleapis.com/v1beta/models/${GEMINI_MODEL}:generateContent?key=${key}`;
  const body = JSON.stringify({
    systemInstruction: { parts:[{ text: system }] },
    contents: [{ role:'user', parts:[{ text: user }] }],
    generationConfig: { temperature:0.25, maxOutputTokens:2000 }
  });

  for (let attempt = 0; attempt < 3; attempt++) {
    let res, raw;
    try {
      res = await fetch(url, { method:'POST', headers:{'Content-Type':'application/json'}, body });
      raw = await res.text();
    } catch(netErr) {
      if (attempt < 2) { await sleep(4000); lastCallAt = Date.now(); continue; }
      throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚¨ãƒ©ãƒ¼: '+netErr.message);
    }

    // â”€â”€ æˆåŠŸ â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    if (res.ok) {
      let data;
      try { data = JSON.parse(raw); } catch(_) {
        throw new Error('Geminiå¿œç­”JSONãŒå£Šã‚Œã¦ã„ã¾ã™: '+raw.slice(0,150));
      }
      const text = data?.candidates?.[0]?.content?.parts?.[0]?.text;
      if (!text) {
        const reason = data?.candidates?.[0]?.finishReason || 'UNKNOWN';
        if (reason === 'SAFETY')     throw new Error('ã‚»ãƒ¼ãƒ•ãƒ†ã‚£ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã§ãƒ–ãƒ­ãƒƒã‚¯ã€‚å•é¡Œæ–‡ã®è¡¨ç¾ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚');
        if (reason === 'RECITATION') throw new Error('è‘—ä½œæ¨©ãƒ•ã‚£ãƒ«ã‚¿ãƒ¼ã«ã‹ã‹ã‚Šã¾ã—ãŸã€‚å•é¡Œæ–‡ã‚’å¤‰ãˆã¦ãã ã•ã„ã€‚');
        throw new Error('Geminiå¿œç­”ãŒç©º (finishReason:'+reason+')');
      }
      return text;
    }

    // â”€â”€ ã‚¨ãƒ©ãƒ¼å‡¦ç† â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    let apiMsg = `HTTP ${res.status}`;
    try { apiMsg = JSON.parse(raw).error?.message || apiMsg; } catch(_) {}

    if (res.status === 401 || res.status === 403) {
      throw new Error(`èªè¨¼ã‚¨ãƒ©ãƒ¼(${res.status}) â€” APIã‚­ãƒ¼ãŒç„¡åŠ¹ã§ã™ã€‚aistudio.google.comã§å†ç™ºè¡Œã—ã¦ãã ã•ã„ã€‚`);
    }

    if (res.status === 429) {
      if (attempt < 2) {
        // Geminiã®ã‚µãƒ¼ãƒãƒ¼å´ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã‚’å®Œå…¨ãƒªã‚»ãƒƒãƒˆã•ã›ã‚‹ãŸã‚95ç§’å¾…ã¤
        showStatus(`âš  Rate Limit (429) â€” ${WAIT_429_SEC}ç§’å¾…æ©Ÿå¾Œã«è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ (${attempt+1}/2)`, 'warn');
        const stop = startCountdown(WAIT_429_SEC);
        await sleep(WAIT_429_SEC * 1000);
        stop(); hideStatus();
        lastCallAt = 0; // å¾…æ©Ÿå¾Œã¯é–“éš”ãƒã‚§ãƒƒã‚¯ã‚’ã‚¹ã‚­ãƒƒãƒ—ã—ã¦å³ãƒªãƒˆãƒ©ã‚¤
        continue;
      }
      throw new Error(`429 Rate Limit â€” 2å›ãƒªãƒˆãƒ©ã‚¤å¤±æ•—ã€‚3åˆ†å¾…ã£ã¦ã‹ã‚‰â†ºRETRYã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚`);
    }

    if (res.status === 400) throw new Error('400 Bad Request: '+apiMsg);
    throw new Error(apiMsg);
  }
  throw new Error('æœ€å¤§ãƒªãƒˆãƒ©ã‚¤å›æ•°è¶…é');
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  CONNECTION TEST
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function testConn() {
  const key = $('apiKey').value.trim();
  const btn = $('testBtn');
  btn.disabled = true; btn.textContent = '...';
  // APIã‚’å©ã‹ãšã‚­ãƒ¼å½¢å¼ã ã‘ãƒã‚§ãƒƒã‚¯ï¼ˆæ ã‚’æ¶ˆè²»ã—ãªã„ï¼‰
  if (!key) {
    showStatus('âœ— APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„', 'err');
  } else if (!key.startsWith('AIza') || key.length < 30) {
    showStatus('âœ— ã‚­ãƒ¼å½¢å¼ãŒé•ã† â€” AIzaSy... ã§å§‹ã¾ã‚‹39æ–‡å­—ã®ã‚­ãƒ¼ã‹ç¢ºèªã—ã¦', 'err');
  } else {
    showStatus('âœ“ ã‚­ãƒ¼å½¢å¼OK â€” ENGAGEã‚’æŠ¼ã—ã¦ã‚¹ã‚¿ãƒ¼ãƒˆï¼ï¼ˆæ¥ç¶šã¯ENGAGEæ™‚ã«ç¢ºèªï¼‰', 'info');
  }
  btn.disabled = false; btn.textContent = 'TEST';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASES
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

// â”€â”€ Phase 1: Goal Refiner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase1(input) {
  setPhase(1,'active');
  loadCard('c1',1,'GOAL REFINEMENT','çœŸã®ç›®æ¨™ã‚’å†å®šç¾©ä¸­');
  const safeInput = input.replace(/\\/g,'\\\\').replace(/"/g,'\\"').slice(0,800);
  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a goal clarification AI. Analyze the input below and respond with ONLY a JSON object.
Do NOT use placeholder text. Write real Japanese content for every field.

Input: "${safeInput}"

Respond with ONLY this JSON structure (replace ALL values with real Japanese content):
{"interpretations":[{"version":"è¡¨é¢çš„è§£é‡ˆ","goal":"[å®Ÿéš›ã®ã‚´ãƒ¼ãƒ«å†…å®¹]","why":"[ç†ç”±]"},{"version":"æ·±å±¤ãƒ‹ãƒ¼ã‚º","goal":"[ã‚ˆã‚Šæ·±ã„ã‚´ãƒ¼ãƒ«å†…å®¹]","why":"[ç†ç”±]"},{"version":"æœ€é©åŒ–è§£é‡ˆ","goal":"[æœ€é©åŒ–ã•ã‚ŒãŸã‚´ãƒ¼ãƒ«å†…å®¹]","why":"[ç†ç”±]"}],"selected":2,"refinedGoal":"[æœ€ã‚‚æ˜ç¢ºãª1æ–‡ã®ã‚´ãƒ¼ãƒ«]","hiddenConstraints":["[åˆ¶ç´„1]","[åˆ¶ç´„2]","[åˆ¶ç´„3]"]}`
  );

  const j = safeJSON(raw);
  if (!j?.refinedGoal) throw new Error('Phase1 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚Geminiã®ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));
  // validate - if refinedGoal contains placeholder text, retry logic
  if (j.refinedGoal.includes('[') || j.refinedGoal === 'æœ€ã‚‚æ˜ç¢ºãª1æ–‡ã®ã‚´ãƒ¼ãƒ«') {
    throw new Error('Phase1: GeminiãŒãƒ—ãƒ¬ãƒ¼ã‚¹ãƒ›ãƒ«ãƒ€ãƒ¼ã‚’è¿”ã—ã¾ã—ãŸã€‚â†ºRETRYã‚’æŠ¼ã—ã¦ãã ã•ã„ã€‚\nç”Ÿã®å¿œç­”: '+raw.slice(0,200));
  }
  ST.goal = j;

  addCard('c1',1,'GOAL REFINEMENT',
    j.interpretations.map((it,i)=>`
      <div class="gbox ${i===j.selected?'sel':''}">
        <div class="g-lbl">${esc(it.version)} ${i===j.selected?'â† SELECTED':''}</div>
        <div class="g-goal">${esc(it.goal)}</div>
        <div class="g-why">${esc(it.why)}</div>
      </div>`).join('')
    +(j.hiddenConstraints?.length?
      `<div class="constraint-list">HIDDEN CONSTRAINTS: ${j.hiddenConstraints.map(c=>`<span>${esc(c)}</span>`).join('')}</div>`:''
    )
  );
  setPhase(1,'done');
  setProgress(1);
}

// â”€â”€ Phase 2: Decomposer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase2() {
  setPhase(2,'active');
  loadCard('c2',2,'PROBLEM DECOMPOSITION','5éšå±¤ã«åˆ†è§£ä¸­');
  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a strategic problem decomposition AI. Analyze the goal below and respond with ONLY a JSON object.
Do NOT use placeholder text. Write real Japanese analysis for every field.

Goal: "${ST.goal.refinedGoal.replace(/"/g,'\\"')}"

Respond with ONLY this JSON (replace ALL bracketed values with real content):
{"layers":[{"level":1,"type":"WHY","question":"ãªãœã“ã‚ŒãŒå•é¡Œã‹","answer":"[å®Ÿéš›ã®åˆ†æ]"},{"level":2,"type":"WHAT","question":"æ ¸å¿ƒè¦ç´ ã¯ä½•ã‹","answer":"[å®Ÿéš›ã®åˆ†æ]"},{"level":3,"type":"HOW","question":"ã©ã†è§£æ±ºã™ã‚‹ã‹","answer":"[å®Ÿéš›ã®åˆ†æ]"},{"level":4,"type":"RISK","question":"ä½•ãŒå¤±æ•—è¦å› ã‹","answer":"[å®Ÿéš›ã®åˆ†æ]"},{"level":5,"type":"METRIC","question":"æˆåŠŸã‚’ä½•ã§æ¸¬ã‚‹ã‹","answer":"[å…·ä½“çš„ãªæ•°å€¤æŒ‡æ¨™]"}],"coreBottleneck":"[æœ€é‡è¦åˆ¶ç´„ã®1æ–‡]"}`
  );

  const j = safeJSON(raw);
  if (!j?.layers?.length) throw new Error('Phase2 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));
  ST.decomp = j;

  const TC = {WHY:'#00ffaa',WHAT:'#9d5cf5',HOW:'#06b6d4',RISK:'#f97316',METRIC:'#f5c400'};
  addCard('c2',2,'PROBLEM DECOMPOSITION',
    j.layers.map(l=>`
      <div class="layer">
        <div class="l-type" style="background:${TC[l.type]||'#999'}15;color:${TC[l.type]||'#999'};border:1px solid ${TC[l.type]||'#999'}40">${l.type}</div>
        <div><div class="l-q">${esc(l.question)}</div><div class="l-a">${esc(l.answer)}</div></div>
      </div>`).join('')
    +`<div class="bottleneck"><div class="b-lbl">CORE BOTTLENECK</div>${esc(j.coreBottleneck)}</div>`
  );
  setPhase(2,'done');
  setProgress(2);
}

// â”€â”€ Phase 3: Strategy Generator â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase3() {
  setPhase(3,'active');
  loadCard('c3',3,'STRATEGY GENERATION','3æˆ¦ç•¥æ¡ˆã‚’ç”Ÿæˆä¸­');
  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a strategy generation AI. Generate 3 strategies for the goal below.
Do NOT use placeholder text. Write real, specific Japanese content.

Goal: "${ST.goal.refinedGoal.replace(/"/g,'\\"')}"
Bottleneck: "${ST.decomp.coreBottleneck.replace(/"/g,'\\"')}"

Respond with ONLY this JSON:
{"strategies":[{"id":"A","archetype":"Conservative","name":"[æˆ¦ç•¥å]","description":"[3ã‚¹ãƒ†ãƒƒãƒ—ã®å…·ä½“çš„ãªè¡Œå‹•è¨ˆç”»]","timeline":"[Xé€±é–“]","resources":"[å¿…è¦ãƒªã‚½ãƒ¼ã‚¹]","keyAssumption":"[å‰ææ¡ä»¶]"},{"id":"B","archetype":"Aggressive","name":"[æˆ¦ç•¥å]","description":"[3ã‚¹ãƒ†ãƒƒãƒ—ã®å…·ä½“çš„ãªè¡Œå‹•è¨ˆç”»]","timeline":"[Xé€±é–“]","resources":"[å¿…è¦ãƒªã‚½ãƒ¼ã‚¹]","keyAssumption":"[å‰ææ¡ä»¶]"},{"id":"C","archetype":"Contrarian","name":"[æˆ¦ç•¥å]","description":"[3ã‚¹ãƒ†ãƒƒãƒ—ã®å…·ä½“çš„ãªè¡Œå‹•è¨ˆç”»]","timeline":"[Xé€±é–“]","resources":"[å¿…è¦ãƒªã‚½ãƒ¼ã‚¹]","keyAssumption":"[å‰ææ¡ä»¶]"}]}`
  );

  const j = safeJSON(raw);
  if (!j?.strategies?.length) throw new Error('Phase3 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));
  ST.strats = j.strategies;

  addCard('c3',3,'STRATEGY GENERATION',
    ST.strats.map(s=>`
      <div class="s-card">
        <div class="s-id" style="color:${COLORS[s.id]}">${s.id} â€” ${esc(s.archetype||'').toUpperCase()}</div>
        <div class="s-name" style="color:${COLORS[s.id]}">${esc(s.name)}</div>
        <div class="s-desc">${esc(s.description)}</div>
        <div class="s-meta">â± ${esc(s.timeline)} &nbsp;|&nbsp; ğŸ“¦ ${esc(s.resources)}</div>
        <div class="s-meta" style="color:var(--p);margin-top:5px">å‰æ: ${esc(s.keyAssumption)}</div>
      </div>`).join('')
  );
  setPhase(3,'done');
  setProgress(3);
}

// â”€â”€ Phase 4: Scorer â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase4() {
  setPhase(4,'active');
  loadCard('c4',4,'5-AXIS SCORING','5è»¸ã‚¹ã‚³ã‚¢ãƒªãƒ³ã‚°ä¸­');
  const stratSummary = ST.strats.map(s=>`${s.id}:${s.name}`).join(', ');
  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a strategic scoring AI. Score these 3 strategies on 5 axes (0-100 integers).
Risk score: 100=safest. Execution score: 100=easiest. Write real Japanese reasons.

Strategies: ${stratSummary}
Goal: "${ST.goal.refinedGoal.replace(/"/g,'\\"')}"

Respond with ONLY this JSON:
{"scores":[{"id":"A","axes":{"strategic":{"score":70,"reason":"[æ ¹æ‹ ]"},"financial":{"score":65,"reason":"[æ ¹æ‹ ]"},"risk":{"score":80,"reason":"[æ ¹æ‹ ]"},"execution":{"score":75,"reason":"[æ ¹æ‹ ]"},"psychological":{"score":70,"reason":"[æ ¹æ‹ ]"}}},{"id":"B","axes":{"strategic":{"score":80,"reason":"[æ ¹æ‹ ]"},"financial":{"score":70,"reason":"[æ ¹æ‹ ]"},"risk":{"score":55,"reason":"[æ ¹æ‹ ]"},"execution":{"score":50,"reason":"[æ ¹æ‹ ]"},"psychological":{"score":65,"reason":"[æ ¹æ‹ ]"}}},{"id":"C","axes":{"strategic":{"score":65,"reason":"[æ ¹æ‹ ]"},"financial":{"score":80,"reason":"[æ ¹æ‹ ]"},"risk":{"score":60,"reason":"[æ ¹æ‹ ]"},"execution":{"score":60,"reason":"[æ ¹æ‹ ]"},"psychological":{"score":60,"reason":"[æ ¹æ‹ ]"}}}]}`
  );

  const j = safeJSON(raw);
  if (!j?.scores?.length) throw new Error('Phase4 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));

  // compute totals
  j.scores.forEach(s => {
    let t = 0;
    Object.entries(W).forEach(([ax,w]) => t += (s.axes[ax]?.score||50)*w);
    s.total = Math.round(t);
    s.prob  = Math.min(94, Math.round(t * 0.85));
  });
  ST.scores = j.scores;

  const axes = ['strategic','financial','risk','execution','psychological'];
  const axL  = {strategic:'STRATEGIC',financial:'FINANCIAL',risk:'RISK',execution:'EXECUTION',psychological:'PSYCHOLOGY'};
  const best = ST.scores.reduce((a,b) => a.total>b.total?a:b);

  const barsHtml = axes.map(ax => `
    <div class="ax-row">
      <div class="ax-head">
        <span style="color:var(--txt2)">${axL[ax]}</span>
        <div class="ax-vals">
          ${ST.scores.map(s=>`<span class="av" style="color:${COLORS[s.id]}" title="${esc(s.axes[ax]?.reason||'')}">${s.id}:${s.axes[ax]?.score??'?'}</span>`).join('')}
        </div>
      </div>
      <div class="bars">
        ${ST.scores.map(s=>`<div class="bt"><div class="bf" style="width:${s.axes[ax]?.score||0}%;background:${COLORS[s.id]}"></div></div>`).join('')}
      </div>
    </div>`).join('');

  const totalsHtml = `<div class="totals">
    ${ST.scores.map(s=>`
      <div class="tc ${s.id===best.id?'win':''}">
        <div class="t-big" style="color:${COLORS[s.id]}">${s.total}</div>
        <div class="t-sub">${s.id} ${s.id===best.id?'â˜… BEST':''}</div>
        <div class="t-prob">æˆåŠŸç¢ºç‡ ${s.prob}%</div>
      </div>`).join('')}
  </div>`;

  addCard('c4',4,'5-AXIS SCORING',
    `<div style="font-size:9px;color:var(--txt2);margin-bottom:12px">
      é‡ã¿: Strategic 25% / Financial 20% / Risk 20% / Execution 20% / Psychology 15%<br>
      ã‚¹ã‚³ã‚¢ã«ãƒã‚¦ã‚¹ã‚ªãƒ¼ãƒãƒ¼ã§æ ¹æ‹ ã‚’è¡¨ç¤º
    </div>
    ${barsHtml}${totalsHtml}
    <div class="chart-wrap">
      <div style="font-size:9px;color:var(--txt2);margin-bottom:10px">RADAR CHART</div>
      <canvas id="radarCanvas"></canvas>
    </div>`
  );

  setTimeout(() => {
    const ctx = document.getElementById('radarCanvas')?.getContext('2d');
    if (!ctx) return;
    if (chartInst) chartInst.destroy();
    chartInst = new Chart(ctx, {
      type: 'radar',
      data: {
        labels: ['Strategic','Financial','Risk','Execution','Psychology'],
        datasets: ST.scores.map(s => ({
          label: 'Strategy '+s.id,
          data: axes.map(ax => s.axes[ax]?.score||0),
          borderColor: COLORS[s.id],
          backgroundColor: COLORS[s.id]+'15',
          pointBackgroundColor: COLORS[s.id],
          borderWidth: 2, pointRadius: 3
        }))
      },
      options: {
        responsive: true,
        plugins: { legend: { labels: { color:'#c0c8e0', font:{family:'Share Tech Mono', size:11} } } },
        scales: { r: {
          min:0, max:100,
          grid: {color:'#1a1a2e'}, angleLines: {color:'#1a1a2e'},
          pointLabels: {color:'#505078', font:{family:'Share Tech Mono', size:10}},
          ticks: {color:'#252535', backdropColor:'transparent', stepSize:25}
        }}
      }
    });
  }, 300);

  setPhase(4,'done');
  setProgress(4);
}

// â”€â”€ Phase 5: Devil's Advocate â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase5() {
  setPhase(5,'active');
  const best  = ST.scores.reduce((a,b) => a.total>b.total?a:b);
  const bestS = ST.strats.find(s => s.id===best.id);
  loadCard('c5',5,"DEVIL'S ADVOCATE",`Strategy ${best.id} ã‚’è«–ç ´ä¸­`);

  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a ruthless strategic skeptic. Attack this strategy mercilessly with specific Japanese critique.
Do NOT use placeholder text.

Target strategy: "${(bestS?.name||'').replace(/"/g,'\\"')}" (Score: ${best.total}/100)
Goal: "${ST.goal.refinedGoal.replace(/"/g,'\\"')}"

Respond with ONLY this JSON:
{"targetId":"${best.id}","attacks":[{"angle":"è²¡å‹™","critique":"[å…·ä½“çš„ãªæ•°å€¤ã‚’ä½¿ã£ãŸåè«–]"},{"angle":"å¸‚å ´","critique":"[å…·ä½“çš„ãªåè«–]"},{"angle":"å®Ÿè¡Œ","critique":"[å…·ä½“çš„ãªåè«–]"},{"angle":"å¤–éƒ¨ç’°å¢ƒ","critique":"[å…·ä½“çš„ãªåè«–]"}],"fatalFlaw":"[è‡´å‘½çš„ãªæ¬ é™¥1æ–‡]","failureProbability":40,"failureTimeline":"[å¤±æ•—ãŒé¡•åœ¨åŒ–ã™ã‚‹ã‚¿ã‚¤ãƒŸãƒ³ã‚°]","worstCase":"[æœ€æ‚ªã®ã‚·ãƒŠãƒªã‚ª1æ–‡]"}`
  );

  const j = safeJSON(raw);
  if (!j?.attacks) throw new Error('Phase5 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));
  ST.devil = j;

  addCard('c5',5,"DEVIL'S ADVOCATE",
    `<div class="d-head">âš  TARGETING STRATEGY ${esc(j.targetId)} â€” ${j.failureProbability}% FAILURE PROBABILITY</div>
    ${j.attacks.map(a=>`
      <div class="d-atk">
        <div class="d-angle">${esc(a.angle)}</div>
        <div class="d-txt">${esc(a.critique)}</div>
      </div>`).join('')}
    <div class="fatal">
      <div class="fatal-lbl">FATAL FLAW â€” ${esc(j.failureTimeline)}</div>
      <div class="fatal-txt">${esc(j.fatalFlaw)}</div>
    </div>
    <div style="margin-top:10px;font-size:11px;color:var(--txt2)">
      WORST CASE: <span style="color:var(--r)">${esc(j.worstCase)}</span>
    </div>`
  );
  setPhase(5,'done');
  setProgress(5);
}

// â”€â”€ Phase 6: Re-Evaluator (è‡ªå¾‹ãƒ«ãƒ¼ãƒ—) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase6() {
  setPhase(6,'active');
  loadCard('c6',6,'AUTONOMOUS RE-EVALUATION','ã‚¹ã‚³ã‚¢ã‚’è‡ªå‹•è£œæ­£ä¸­');
  await sleep(300);

  const tgt   = ST.devil.targetId;
  const fp    = ST.devil.failureProbability || 40;
  const pen   = fp > 60 ? 0.85 : fp > 40 ? 0.91 : 0.95;
  const bonus = 1.025;

  ST.final = ST.scores.map(s => {
    const adj  = Math.min(99, Math.round(s.total * (s.id===tgt ? pen : bonus)));
    const prob = Math.min(94, Math.round(adj * 0.84 - (fp>50?5:2)));
    return {...s, adj, prob};
  });

  // auto-loop: narrow spread â†’ apply discrimination
  const vals   = ST.final.map(s => s.adj);
  const spread = Math.max(...vals) - Math.min(...vals);
  let note = '';
  if (spread < 8) {
    const sorted = [...ST.final].sort((a,b)=>b.adj-a.adj);
    sorted[0].adj += 3;
    sorted[2].adj -= 3;
    note = `<div style="font-size:10px;color:var(--p);margin-top:10px">âŸ³ AUTO-LOOP: ã‚¹ã‚³ã‚¢å·®${spread}pt â†’ è‡ªå‹•å·®åˆ¥åŒ–è£œæ­£ã‚’é©ç”¨</div>`;
  }

  const winner = ST.final.reduce((a,b) => a.adj>b.adj?a:b);

  addCard('c6',6,'AUTONOMOUS RE-EVALUATION',
    `<div style="font-size:11px;color:var(--txt2);margin-bottom:14px">
      Strategy ${tgt}: Ã—${pen} penalty (å¤±æ•—ç¢ºç‡${fp}%) &nbsp;|&nbsp; Others: Ã—${bonus} bonus
    </div>
    <div class="totals">
      ${ST.final.map(s=>`
        <div class="tc ${s.id===winner.id?'win':''}">
          <div style="font-size:10px;color:var(--txt2);margin-bottom:3px">å…ƒ: ${s.total}</div>
          <div class="t-big" style="color:${COLORS[s.id]}">${s.adj}</div>
          <div class="t-sub">${s.id} ${s.id===winner.id?'â˜… WINNER':''}</div>
          <div class="t-prob">æˆåŠŸç¢ºç‡ ${s.prob}%</div>
        </div>`).join('')}
    </div>${note}`
  );
  setPhase(6,'done');
  setProgress(6);
}

// â”€â”€ Phase 7: Verdict â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function phase7() {
  setPhase(7,'active');
  const winner = ST.final.reduce((a,b) => a.adj>b.adj?a:b);
  const winS   = ST.strats.find(s => s.id===winner.id);
  loadCard('c7',7,'FINAL VERDICT','æœ€çµ‚æ±ºæ–­ã‚’ç”Ÿæˆä¸­');

  const raw = await callGemini(
    'You output ONLY raw JSON. Never add markdown, code fences, or explanation.',
    `You are a decisive strategic verdict AI. Write real, specific Japanese content. Do NOT use placeholder text.

Winner: Strategy ${winner.id} "${(winS?.name||'').replace(/"/g,'\\"')}" (Score:${winner.adj}, P(success):${winner.prob}%)
Goal: "${ST.goal.refinedGoal.replace(/"/g,'\\"')}"
Fatal Risk: "${(ST.devil.fatalFlaw||'').replace(/"/g,'\\"')}"

Respond with ONLY this JSON:
{"verdict":"[å‘½ä»¤å½¢1æ–‡ã®æœ€çµ‚æ±ºæ–­ã€‚æ›–æ˜§èªç¦æ­¢ã€‚å…·ä½“çš„è¡Œå‹•ã¨æ•°å€¤ã‚’å«ã‚€]","successProbability":${winner.prob},"reasons":["[æ•°å€¤æ ¹æ‹ ã®ã‚ã‚‹ç†ç”±1]","[ç†ç”±2]","[ç†ç”±3]"],"firstAction":"[ä»Šæ—¥24æ™‚é–“ä»¥å†…ã«å–ã‚‹ã¹ãæœ€å°ãƒ»æœ€é«˜ãƒ¬ãƒãƒ¬ãƒƒã‚¸ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³1æ–‡]","exitCriteria":"[ã“ã®æˆ¦ç•¥ã‚’æ¨ã¦ã‚‹ã¹ãå…·ä½“çš„ãªæ•°å€¤æ¡ä»¶]"}`
  );

  const j = safeJSON(raw);
  if (!j?.verdict) throw new Error('Phase7 JSONãƒ‘ãƒ¼ã‚¹å¤±æ•—ã€‚ç”Ÿã®å¿œç­”:\n'+raw.slice(0,500));

  addCard('c7',7,'FINAL VERDICT',
    `<div class="v-box">
      <div class="v-circle">
        <div class="v-num">${j.successProbability}%</div>
        <div class="v-sub">SUCCESS</div>
      </div>
      <div class="v-txt">"${esc(j.verdict)}"</div>
      <div class="v-reasons">
        ${(j.reasons||[]).map(r=>`<div class="v-reason">${esc(r)}</div>`).join('')}
      </div>
      <div class="v-meta">
        <div class="v-mbox" style="border-color:var(--g)40">
          <div class="v-mlbl" style="color:var(--g)">FIRST ACTION / 24H</div>
          <div class="v-mtxt">${esc(j.firstAction)}</div>
        </div>
        <div class="v-mbox" style="border-color:var(--r)40">
          <div class="v-mlbl" style="color:var(--r)">EXIT CRITERIA</div>
          <div class="v-mtxt" style="color:var(--txt2)">${esc(j.exitCriteria)}</div>
        </div>
      </div>
    </div>`
  );
  setPhase(7,'done');
  setProgress(7);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  PHASE RETRY (individual phase)
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function retryPhase(n) {
  if (isRunning) return;
  const phFns = [null, ()=>phase1($('prob').value.trim()), phase2, phase3, phase4, phase5, phase6, phase7];
  if (!phFns[n]) return;

  isRunning = true;
  setDot('run');
  setPhase(n,'active');
  try {
    await phFns[n]();
    // continue from next phase
    for (let i=n+1; i<=7; i++) {
      showStatus(`Phase ${i}/7 ã‚’æº–å‚™ä¸­...`, 'info');
      await sleep(PHASE_GAP_MS);
      hideStatus();
      setPhase(i,'active');
      await phFns[i]();
    }
    setDot('ok');
    showStatus('âœ“ åˆ†æå®Œäº†', 'info');
  } catch(e) {
    showErrCard('c'+n, n, 'PHASE '+n, e.message);
    setDot('err');
  }
  isRunning = false;
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
//  MAIN RUNNER
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function runAPEX() {
  if (isRunning) return;
  const key   = $('apiKey').value.trim();
  const input = $('prob').value.trim();
  if (!key)   { showStatus('Gemini APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„ â†’ aistudio.google.com ã§å–å¾—','err'); $('status-bar').style.display='block'; return; }
  if (!input) { showStatus('åˆ†æã™ã‚‹å•é¡Œãƒ»ç›®æ¨™ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„','err'); $('status-bar').style.display='block'; return; }

  clearAll();
  isRunning = true;
  $('runBtn').disabled = true;
  $('runBtn').textContent = 'â—‰ RUNNING...';
  setDot('run');

  const phases = [
    {fn:()=>phase1(input), label:'GOAL REFINEMENT'},
    {fn:phase2,            label:'DECOMPOSITION'},
    {fn:phase3,            label:'STRATEGY GEN'},
    {fn:phase4,            label:'SCORING'},
    {fn:phase5,            label:"DEVIL'S ADVOCATE"},
    {fn:phase6,            label:'RE-EVALUATION'},
    {fn:phase7,            label:'FINAL VERDICT'},
  ];

  let ok = true;
  for (let i=0; i<phases.length; i++) {
    // inter-phase visual gap (rate limiting is handled proactively by rateGate)
    if (i > 0) {
      showStatus(`Phase ${i+1}/7: ${phases[i].label} ã‚’æº–å‚™ä¸­...`, 'info');
      await sleep(PHASE_GAP_MS);
      hideStatus();
    }
    try {
      await phases[i].fn();
    } catch(e) {
      showErrCard('c'+(i+1), i+1, phases[i].label, e.message);
      showStatus(`âš  Phase ${i+1} ã§ã‚¨ãƒ©ãƒ¼ â€” ã‚«ãƒ¼ãƒ‰å†…ã®ã€Œâ†º RETRYã€ã§å†è©¦è¡Œã§ãã¾ã™`, 'err');
      setDot('err');
      ok = false;
      break;
    }
  }

  if (ok) {
    setDot('ok');
    showStatus('âœ“ å…¨7ãƒ•ã‚§ãƒ¼ã‚ºå®Œäº† â€” æœ€çµ‚æ±ºæ–­ã‚’ç¢ºèªã—ã¦ãã ã•ã„', 'info');
  }

  isRunning = false;
  $('runBtn').disabled = false;
  $('runBtn').textContent = 'â–¶ ENGAGE APEX';
}
</script>
</body>
</html>
