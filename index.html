<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>APEX Î© â€“ ULTIMA v3</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#05050a;--card:#0d0d18;--border:#1a1a2e;
  --g:#00ffaa;--r:#ff5e5e;--t:#cfd8ff;--d:#8892b0;--y:#f5c400;--p:#b57bff;
  --g-dim:rgba(0,255,170,.06);--g-b:rgba(0,255,170,.3);
  --r-dim:rgba(255,94,94,.06);--r-b:rgba(255,94,94,.3);
  --y-dim:rgba(245,196,0,.06);--y-b:rgba(245,196,0,.3);
  --p-dim:rgba(181,123,255,.06);--p-b:rgba(181,123,255,.3);
}
body{font-family:system-ui,-apple-system,sans-serif;background:radial-gradient(circle at top,#16162a 0,#05050a 65%);color:var(--t);padding:16px}
.shell{max-width:900px;margin:auto}

/* â”€â”€ cards â”€â”€ */
.card{background:var(--card);border:1px solid var(--border);border-radius:14px;padding:16px;margin-bottom:14px;box-shadow:0 20px 60px rgba(0,0,0,.6)}

/* â”€â”€ inputs â”€â”€ */
h1{font-size:1.1rem;font-weight:700;margin-bottom:12px;letter-spacing:.03em}
.subtitle{font-size:.72rem;color:var(--d);letter-spacing:.1em;text-transform:uppercase;margin-bottom:14px}
input,textarea{width:100%;background:#070712;color:var(--t);border:1px solid var(--border);border-radius:10px;padding:10px;font-size:.88rem;transition:border-color .2s}
input{margin-top:6px}
textarea{min-height:88px;resize:vertical;margin-top:8px}
input:focus,textarea:focus{outline:none;border-color:var(--g-b)}
button{border:none;border-radius:999px;padding:9px 20px;margin-top:10px;cursor:pointer;font-weight:700;font-size:.82rem;letter-spacing:.03em;transition:all .2s}
button:disabled{opacity:.35;cursor:not-allowed}
.btn-run{background:linear-gradient(135deg,#00ffaa,#4df3ff);color:#000}
.btn-run:hover:not(:disabled){box-shadow:0 0 20px rgba(0,255,170,.4)}
.btn-ghost{background:transparent;border:1px solid #333;color:#888;margin-left:8px}
.btn-ghost:hover:not(:disabled){border-color:#666;color:#ccc}

/* â”€â”€ status / countdown â”€â”€ */
.status{font-size:.78rem;margin-top:10px;padding:8px 12px;border-radius:8px;min-height:34px;line-height:1.6;border:1px solid transparent}
.status.ok  {color:var(--g);background:var(--g-dim);border-color:var(--g-b)}
.status.warn{color:var(--y);background:var(--y-dim);border-color:var(--y-b)}
.status.err {color:var(--r);background:var(--r-dim);border-color:var(--r-b)}
#cd{display:none;align-items:center;gap:10px;margin-top:8px;font-size:.78rem;color:var(--d)}
#cd.show{display:flex}
#cd-n{font-weight:700;color:var(--y);min-width:28px;text-align:right}
#cd-t{flex:1;height:3px;background:var(--border);border-radius:2px;overflow:hidden}
#cd-f{height:3px;background:var(--y)}

/* â”€â”€ phase strip â”€â”€ */
#phases{display:flex;gap:6px;margin-top:14px;flex-wrap:wrap}
.ph{font-size:.68rem;letter-spacing:.1em;padding:4px 10px;border-radius:999px;border:1px solid var(--border);color:var(--d);transition:.3s}
.ph.active{border-color:var(--y-b);color:var(--y);background:var(--y-dim)}
.ph.done{border-color:var(--g-b);color:var(--g);background:var(--g-dim)}
.ph.err{border-color:var(--r-b);color:var(--r)}

/* â”€â”€ decompose block â”€â”€ */
#decomp-card{display:none}
.decomp-row{display:flex;gap:10px;margin-bottom:10px;align-items:flex-start}
.decomp-tag{font-size:.65rem;letter-spacing:.1em;padding:3px 8px;border-radius:4px;white-space:nowrap;flex-shrink:0;margin-top:2px}
.decomp-q{font-size:.75rem;color:var(--d);margin-bottom:3px}
.decomp-a{font-size:.85rem;line-height:1.65}
.bottleneck{border:1px solid var(--p-b);border-radius:8px;background:var(--p-dim);padding:12px;margin-top:12px}
.bottleneck-lbl{font-size:.68rem;letter-spacing:.1em;color:var(--p);margin-bottom:5px}

/* â”€â”€ agent grid â”€â”€ */
#agents-card{display:none}
.agent-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:10px}
.agent-box{border-radius:10px;padding:12px;border:1px solid}
.agent-box.alpha{border-color:rgba(0,200,255,.3);background:rgba(0,200,255,.04)}
.agent-box.beta {border-color:rgba(0,255,170,.3);background:rgba(0,255,170,.04)}
.agent-box.gamma{border-color:rgba(255,94,94,.3); background:rgba(255,94,94,.04)}
.agent-box.delta{border-color:rgba(181,123,255,.3);background:rgba(181,123,255,.04)}
.agent-name{font-size:.68rem;letter-spacing:.12em;text-transform:uppercase;margin-bottom:4px;font-weight:700}
.agent-role{font-size:.65rem;color:var(--d);margin-bottom:8px}
.agent-box.alpha .agent-name{color:#00c8ff}
.agent-box.beta  .agent-name{color:var(--g)}
.agent-box.gamma .agent-name{color:var(--r)}
.agent-box.delta .agent-name{color:var(--p)}
.agent-body{font-size:.84rem;line-height:1.7;white-space:pre-wrap}
.agent-stance{font-size:.72rem;margin-top:8px;padding:6px 8px;border-radius:5px;background:rgba(255,255,255,.04);color:var(--d)}

/* â”€â”€ verdict â”€â”€ */
#verdict-card{display:none}
.verdict-box{border:1px solid var(--g-b);border-radius:12px;background:var(--g-dim);padding:20px}
.verdict-prob{text-align:center;margin-bottom:18px}
.v-circle{width:88px;height:88px;border-radius:50%;border:2px solid var(--g);margin:0 auto 10px;display:flex;flex-direction:column;align-items:center;justify-content:center;box-shadow:0 0 30px rgba(0,255,170,.2)}
.v-big{font-size:26px;font-weight:900;color:var(--g);line-height:1}
.v-sub{font-size:.6rem;color:var(--d);letter-spacing:.12em}
.verdict-text{font-size:1rem;font-weight:700;line-height:1.6;color:var(--g);text-align:center;margin-bottom:18px;font-style:italic}
.verdict-section{margin-bottom:14px}
.vs-label{font-size:.65rem;letter-spacing:.12em;color:var(--d);text-transform:uppercase;margin-bottom:6px}
.vs-item{font-size:.84rem;line-height:1.7;padding:5px 0;border-bottom:1px solid var(--border)}
.vs-item:last-child{border:none}
.vs-item::before{content:'â†’ ';color:var(--g)}
.verdict-meta{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:14px}
.vm-box{border:1px solid var(--border);border-radius:8px;padding:12px}
.vm-label{font-size:.65rem;letter-spacing:.1em;margin-bottom:5px}
.vm-text{font-size:.82rem;line-height:1.6}
.vm-box.action .vm-label{color:var(--g)}
.vm-box.exit   .vm-label{color:var(--r)}
.consensus-bar{margin-top:14px;border:1px solid var(--border);border-radius:8px;padding:12px}
.cb-label{font-size:.65rem;letter-spacing:.1em;color:var(--d);margin-bottom:8px}
.cb-row{display:flex;align-items:center;gap:8px;margin-bottom:6px;font-size:.78rem}
.cb-name{width:55px;color:var(--d)}
.cb-track{flex:1;height:5px;background:var(--border);border-radius:3px;overflow:hidden}
.cb-fill{height:5px;border-radius:3px;transition:width 1s ease}
.cb-val{width:30px;text-align:right;font-weight:700}

/* â”€â”€ loading dots â”€â”€ */
.loading-dots::after{content:'';animation:ldots 1.2s infinite}
@keyframes ldots{0%{content:''}25%{content:'.'}50%{content:'..'}75%{content:'...'}100%{content:''}}

/* â”€â”€ util â”€â”€ */
.section-label{font-size:.68rem;letter-spacing:.15em;color:var(--d);text-transform:uppercase;margin-bottom:12px;padding-bottom:6px;border-bottom:1px solid var(--border)}
.meta{font-size:.7rem;color:#444;margin-top:10px}
</style>
</head>
<body>
<div class="shell">

<!-- â”€â”€ INPUT â”€â”€ -->
<div class="card">
  <div class="subtitle">APEX Î© â€“ ULTIMA v3 Â· Web Search + Multi-Agent</div>
  <h1>æˆ¦ç•¥çš„æ„æ€æ±ºå®šã‚¨ãƒ³ã‚¸ãƒ³</h1>
  <input type="password" id="key" placeholder="Groq API Key â€” console.groq.com ã§ç„¡æ–™å–å¾— (gsk_...)">
  <textarea id="q" placeholder="æ„æ€æ±ºå®šãƒ»æˆ¦ç•¥èª²é¡Œãƒ»å•é¡Œã‚’å…¥åŠ›...&#10;ä¾‹: å‰¯æ¥­ã§YouTubeã‚’å§‹ã‚ã‚‹ã¹ãã‹ã€‚æœ¬æ¥­ä¼šç¤¾å“¡ã€é€±10æ™‚é–“ç¢ºä¿å¯ã€è²¯é‡‘200ä¸‡ã€‚6ãƒ¶æœˆã§æœˆ5ä¸‡ç¨¼ããŸã„ã€‚"></textarea>
  <div>
    <button class="btn-run" id="run_btn" onclick="run()">â–¶ åˆ†æé–‹å§‹</button>
    <button class="btn-ghost" onclick="clearAll()">ãƒªã‚»ãƒƒãƒˆ</button>
    <button class="btn-ghost" onclick="clearCache()">ã‚­ãƒ£ãƒƒã‚·ãƒ¥å‰Šé™¤</button>
  </div>
  <div id="status" class="status"></div>
  <div id="cd"><span>å¾…æ©Ÿä¸­</span><span id="cd-n">â€”</span><span>ç§’</span><div id="cd-t"><div id="cd-f"></div></div></div>
  <div id="phases">
    <div class="ph" id="ph1">â‘  å•é¡Œåˆ†è§£</div>
    <div class="ph" id="ph2">â‘¡ 4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆåˆ†æ</div>
    <div class="ph" id="ph3">â‘¢ Î©çµ±åˆãƒ»æœ€çµ‚æ±ºæ–­</div>
  </div>
</div>

<!-- â”€â”€ DECOMPOSE â”€â”€ -->
<div class="card" id="decomp-card">
  <div class="section-label">Phase 1 â€” å•é¡Œã®æ·±å±¤åˆ†è§£</div>
  <div id="decomp-body"></div>
</div>

<!-- â”€â”€ AGENTS â”€â”€ -->
<div class="card" id="agents-card">
  <div class="section-label">Phase 2 â€” 4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‹¬ç«‹åˆ†æ</div>
  <div class="agent-grid">
    <div class="agent-box alpha">
      <div class="agent-name">Î± ã‚¹ãƒˆãƒ©ãƒ†ã‚¸ã‚¹ãƒˆ</div>
      <div class="agent-role">å…ƒMcKinsey / ç«¶äº‰æˆ¦ç•¥ãƒ»å¸‚å ´åˆ†æã®å°‚é–€å®¶</div>
      <div id="ag-a" class="agent-body"></div>
      <div id="st-a" class="agent-stance"></div>
    </div>
    <div class="agent-box beta">
      <div class="agent-name">Î² ã‚ªãƒšãƒ¬ãƒ¼ã‚¿ãƒ¼</div>
      <div class="agent-role">å…ƒAmazon / å®Ÿè¡Œãƒ»ãƒªã‚½ãƒ¼ã‚¹æœ€é©åŒ–ã®å°‚é–€å®¶</div>
      <div id="ag-b" class="agent-body"></div>
      <div id="st-b" class="agent-stance"></div>
    </div>
    <div class="agent-box gamma">
      <div class="agent-name">Î³ ãƒ‡ãƒ“ãƒ«ã‚ºã‚¢ãƒ‰ãƒœã‚±ã‚¤ãƒˆ</div>
      <div class="agent-role">ãƒªã‚¹ã‚¯ç®¡ç† / åè«–ãƒ»æ¬ é™¥ç™ºè¦‹ã®å°‚é–€å®¶</div>
      <div id="ag-c" class="agent-body"></div>
      <div id="st-c" class="agent-stance"></div>
    </div>
    <div class="agent-box delta">
      <div class="agent-name">Î´ ãƒ•ã‚£ãƒ­ã‚½ãƒ•ã‚¡ãƒ¼</div>
      <div class="agent-role">ç¬¬ä¸€åŸç†æ€è€ƒ / æœ¬è³ªãƒ»æ§‹é€ åˆ†æã®å°‚é–€å®¶</div>
      <div id="ag-d" class="agent-body"></div>
      <div id="st-d" class="agent-stance"></div>
    </div>
  </div>
</div>

<!-- â”€â”€ VERDICT â”€â”€ -->
<div class="card" id="verdict-card">
  <div class="section-label">Phase 3 â€” Î© æœ€çµ‚çµ±åˆåˆ¤æ–­</div>
  <div id="verdict-body"></div>
</div>

<div class="meta" id="meta"></div>

</div><!-- /shell -->
<script>
'use strict';

/* â”€â”€ CONFIG â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';
const MODEL    = 'compound-beta';  // Groq compound: LLM + Webæ¤œç´¢å†…è”µã€è¿½åŠ ã‚­ãƒ¼ä¸è¦
const CALL_GAP = 4000;
const WAIT_429 = 65;
const MAX_RETRY = 2;
const CACHE_TTL = 7 * 24 * 60 * 60 * 1000;
const CACHE_MAX = 40;
const PFX = 'apexv3_';

/* â”€â”€ STATE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
let running = false, lastCallAt = 0, callCount = 0, cdIv = null;
let ST = {};

/* â”€â”€ DOM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const $ = id => document.getElementById(id);
const setStatus = (msg, type='') => {
  const s = $('status');
  s.textContent = msg;
  s.className = 'status' + (type ? ' '+type : '');
};
const setPhase = (n, state) => {
  const e = $('ph'+n);
  if(e) e.className = 'ph ' + state;
};

function startCd(sec) {
  const f = $('cd-f');
  if(cdIv) clearInterval(cdIv);
  $('cd').classList.add('show');
  let r = sec;
  $('cd-n').textContent = r;
  f.style.transition = 'none'; f.style.width = '100%';
  void f.offsetWidth;
  f.style.transition = `width ${sec}s linear`; f.style.width = '0%';
  cdIv = setInterval(() => { r--; $('cd-n').textContent = Math.max(0,r); if(r<=0) stopCd(); }, 1000);
}
function stopCd() {
  if(cdIv){ clearInterval(cdIv); cdIv=null; }
  $('cd').classList.remove('show');
}

function esc(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

/* â”€â”€ CACHE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
const cacheGet = k => {
  try {
    const d = JSON.parse(localStorage.getItem(k)||'null');
    if(!d || Date.now()-d.t > CACHE_TTL){ localStorage.removeItem(k); return null; }
    d.last = Date.now(); localStorage.setItem(k, JSON.stringify(d));
    return d.v;
  } catch(_){ return null; }
};
const cacheSet = (k,v) => {
  try {
    const keys = Object.keys(localStorage).filter(x=>x.startsWith(PFX));
    if(keys.length >= CACHE_MAX){
      const old = keys.map(k=>[k,(JSON.parse(localStorage.getItem(k))||{last:0}).last]).sort((a,b)=>a[1]-b[1])[0][0];
      localStorage.removeItem(old);
    }
    localStorage.setItem(k, JSON.stringify({t:Date.now(),last:Date.now(),v}));
  } catch(_){}
};
const clearCache = () => {
  Object.keys(localStorage).filter(k=>k.startsWith(PFX)).forEach(k=>localStorage.removeItem(k));
  setStatus('ã‚­ãƒ£ãƒƒã‚·ãƒ¥ã‚’å‰Šé™¤ã—ã¾ã—ãŸ','ok');
};

/* â”€â”€ JSON PARSER â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function safeJSON(text) {
  if(!text) return null;
  const strip = s => s.replace(/^```(?:json)?\s*/im,'').replace(/\s*```\s*$/,'').trim();
  try{ return JSON.parse(text); }catch(_){}
  try{ return JSON.parse(strip(text)); }catch(_){}
  const m = text.match(/\{[\s\S]*\}/);
  if(m){
    try{ return JSON.parse(m[0]); }catch(_){}
    try{ return JSON.parse(m[0].replace(/,\s*([}\]])/g,'$1').replace(/([{,]\s*)(\w+)\s*:/g,'$1"$2":"')); }catch(_){}
  }
  return null;
}

/* â”€â”€ API CALL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
async function callAPI(systemPrompt, userPrompt) {
  const key = $('key').value.trim();
  if(!key) throw new Error('APIã‚­ãƒ¼ã‚’å…¥åŠ›ã—ã¦ãã ã•ã„');

  const gap = CALL_GAP - (Date.now() - lastCallAt);
  if(gap > 0){
    const s = Math.ceil(gap/1000);
    setStatus(`â³ ${s}ç§’å¾…æ©Ÿä¸­...`, 'warn');
    startCd(s);
    await new Promise(r=>setTimeout(r,gap));
    stopCd();
  }

  for(let attempt=0; attempt<=MAX_RETRY; attempt++){
    lastCallAt = Date.now();
    let res, raw;
    try {
      const ctrl = new AbortController();
      const tid  = setTimeout(()=>ctrl.abort(), 45000); // compound-betaã¯æ¤œç´¢åˆ†é…ã„
      res = await fetch(ENDPOINT, {
        method:  'POST',
        headers: { 'Content-Type':'application/json', 'Authorization':'Bearer '+key },
        body: JSON.stringify({
          model: MODEL,
          messages: [
            { role:'system', content: systemPrompt },
            { role:'user',   content: userPrompt }
          ],
          temperature: 0.4,
          max_tokens: 3000
        }),
        signal: ctrl.signal
      });
      clearTimeout(tid);
      raw = await res.text();
    } catch(e){
      if(attempt < MAX_RETRY){ await new Promise(r=>setTimeout(r,4000)); continue; }
      throw new Error('ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯ã‚¨ãƒ©ãƒ¼: '+e.message);
    }

    if(res.ok){
      let data;
      try{ data=JSON.parse(raw); }catch(_){ throw new Error('å¿œç­”JSONãŒå£Šã‚Œã¦ã„ã¾ã™'); }
      const txt = data?.choices?.[0]?.message?.content;
      if(!txt) throw new Error('å¿œç­”ãŒç©ºã§ã™');

      // compound-betaã®æ¤œç´¢ã‚½ãƒ¼ã‚¹ã‚’æŠ½å‡ºã—ã¦STã«ä¿å­˜
      const sources = data?.choices?.[0]?.message?.tool_calls
        ?.filter(t=>t.type==='web_search')
        ?.map(t=>{ try{ return JSON.parse(t.function?.arguments||'{}').query; }catch(_){return null;} })
        ?.filter(Boolean) || [];
      if(sources.length) ST.searchSources = (ST.searchSources||[]).concat(sources);

      callCount++;
      $('meta').textContent = `APIå‘¼ã³å‡ºã—: ${callCount}å›${ST.searchSources?.length ? ` | Webæ¤œç´¢: ${ST.searchSources.length}ä»¶` : ''}`;
      return txt;
    }

    let apiErr = 'HTTP '+res.status;
    try{ apiErr = JSON.parse(raw).error?.message || apiErr; }catch(_){}
    if(res.status===401||res.status===403)
      throw new Error('èªè¨¼ã‚¨ãƒ©ãƒ¼ â€” console.groq.com ã§APIã‚­ãƒ¼ã‚’ç¢ºèªã—ã¦ãã ã•ã„');
    if(res.status===429){
      if(attempt<MAX_RETRY){
        setStatus(`âš  Rate Limit â€” ${WAIT_429}ç§’å¾Œã«è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤`, 'warn');
        startCd(WAIT_429);
        await new Promise(r=>setTimeout(r,WAIT_429*1000));
        stopCd(); lastCallAt=0; continue;
      }
      throw new Error('429 Rate Limit â€” 1åˆ†å¾Œã«å†å®Ÿè¡Œã—ã¦ãã ã•ã„');
    }
    throw new Error(apiErr);
  }
}

/* â”€â”€ CLEAR â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€ */
function clearAll() {
  ST = {};
  ['decomp-card','agents-card','verdict-card'].forEach(id=>$(id).style.display='none');
  ['decomp-body','ag-a','ag-b','ag-c','ag-d','st-a','st-b','st-c','st-d','verdict-body'].forEach(id=>{ const e=$(id); if(e) e.innerHTML=''; });
  [1,2,3].forEach(n=>setPhase(n,''));
  setStatus(''); stopCd();
  callCount=0; $('meta').textContent='';
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 1 â€” æ·±å±¤å•é¡Œåˆ†è§£ (Chain-of-Thought)
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function phase1(q) {
  setPhase(1,'active');
  setStatus('Phase 1: å•é¡Œã‚’æ·±å±¤åˆ†è§£ä¸­...', '');
  $('decomp-card').style.display='block';
  $('decomp-body').innerHTML='<div class="loading-dots" style="color:var(--d)">åˆ†æä¸­</div>';

  const raw = await callAPI(
    `ã‚ãªãŸã¯Webæ¤œç´¢æ©Ÿèƒ½ã‚’æŒã¤æˆ¦ç•¥ã‚¢ãƒŠãƒªã‚¹ãƒˆã§ã™ã€‚
å¿…ãšé–¢é€£ã™ã‚‹æœ€æ–°æƒ…å ±ã‚’Webæ¤œç´¢ã—ã¦ã‹ã‚‰åˆ†æã—ã¦ãã ã•ã„ã€‚
JSONã®ã¿ã§å¿œç­”ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãƒ»å‰ç½®ããƒ»å¾Œæ›¸ãä¸€åˆ‡ä¸è¦ã€‚`,

    `ä»¥ä¸‹ã®å•ã„ã«ã¤ã„ã¦ã€ã¾ãšWebæ¤œç´¢ã§æœ€æ–°ã®é–¢é€£æƒ…å ±ãƒ»çµ±è¨ˆãƒ»äº‹ä¾‹ã‚’åé›†ã—ã¦ã‹ã‚‰ã€æ·±å±¤åˆ†è§£ã—ã¦ãã ã•ã„ã€‚

å•ã„: ${q}

æ¤œç´¢ã™ã¹ãæƒ…å ±ã®ä¾‹ï¼šã“ã®å•ã„ã«é–¢é€£ã™ã‚‹æœ€æ–°çµ±è¨ˆã€æˆåŠŸ/å¤±æ•—äº‹ä¾‹ã€æ¥­ç•Œå‹•å‘ã€å…·ä½“çš„ãªæ•°å€¤ãƒ‡ãƒ¼ã‚¿

åé›†ã—ãŸå®Ÿéš›ã®æƒ…å ±ã‚’ä½¿ã£ã¦ã€ä»¥ä¸‹ã®JSONã‚’åŸ‹ã‚ã¦ãã ã•ã„ï¼ˆã™ã¹ã¦ã®ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ã«å…·ä½“çš„ãªæ•°å€¤ãƒ»äº‹ä¾‹ãƒ»å‡ºå…¸ã‚’å«ã‚ã‚‹ã“ã¨ï¼‰:

{
  "web_findings": "Webæ¤œç´¢ã§å¾—ãŸæœ€é‡è¦ã®äº‹å®Ÿãƒ»æ•°å€¤ãƒ»äº‹ä¾‹ï¼ˆç®‡æ¡æ›¸ãã€å„é …ç›®ã«å‡ºå…¸ã‚’ç¤ºã™ï¼‰",
  "real_problem": "æ¤œç´¢çµæœã‚’è¸ã¾ãˆãŸã€æœ¬å½“ã®å•é¡Œã®å®šç¾©ï¼ˆæ•°å€¤ãƒ»äº‹ä¾‹ã§è£ä»˜ã‘ã‚‹ï¼‰",
  "dangerous_assumption": "ã“ã®å•ã„ã«æ½œã‚€æœ€ã‚‚å±é™ºãªæ€ã„è¾¼ã¿ï¼ˆæ¤œç´¢ã§å¾—ãŸåè¨¼ãƒ‡ãƒ¼ã‚¿ã‚’ç¤ºã™ï¼‰",
  "market_reality": "æ¤œç´¢ã§åˆ¤æ˜ã—ãŸå¸‚å ´ãƒ»æ¥­ç•Œã®å®Ÿæ…‹ï¼ˆæˆåŠŸç‡ãƒ»å¹³å‡å€¤ãƒ»æœ€æ–°ãƒˆãƒ¬ãƒ³ãƒ‰ãªã©å…·ä½“çš„æ•°å€¤ï¼‰",
  "bottleneck": "ãƒ‡ãƒ¼ã‚¿ã«åŸºã¥ãæœ€é‡è¦ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ï¼ˆã“ã®åˆ¶ç´„ã‚’è§£é™¤ã™ã‚Œã°ä»–ãŒé€£é–ã™ã‚‹ï¼‰",
  "reframed": "æ¤œç´¢çµæœã‚’è¸ã¾ãˆã¦å†å®šç¾©ã•ã‚ŒãŸã€ã‚ˆã‚Šæ­£ç¢ºãªå•ã„"
}`
  );

  const j = safeJSON(raw);
  if(!j?.reframed) throw new Error('Phase1 ãƒ‘ãƒ¼ã‚¹å¤±æ•—: '+raw.slice(0,200));
  ST.decomp = j;

  const colors = {web_findings:'#00c8ff',real_problem:'#00ffaa',dangerous_assumption:'#f5c400',market_reality:'#b57bff',bottleneck:'#ff5e5e',reframed:'#00ffaa'};
  const labels = {web_findings:'ğŸŒ Webæ¤œç´¢çµæœ',real_problem:'çœŸã®å•é¡Œ',dangerous_assumption:'å±é™ºãªæ€ã„è¾¼ã¿',market_reality:'å¸‚å ´ã®å®Ÿæ…‹',bottleneck:'ãƒœãƒˆãƒ«ãƒãƒƒã‚¯',reframed:'å†å®šç¾©ã•ã‚ŒãŸå•ã„'};
  const keys   = ['web_findings','real_problem','dangerous_assumption','market_reality','bottleneck','reframed'];

  $('decomp-body').innerHTML = keys.map(k=>`
    <div class="decomp-row">
      <div class="decomp-tag" style="background:${colors[k]}18;color:${colors[k]};border:1px solid ${colors[k]}40">${labels[k]}</div>
      <div><div class="decomp-a">${esc(j[k])}</div></div>
    </div>`).join('')
    + `<div class="bottleneck">
        <div class="bottleneck-lbl">â—‰ å†å®šç¾©ã•ã‚ŒãŸå•ã„</div>
        <div style="font-size:.9rem;font-weight:600;color:var(--p)">${esc(j.reframed)}</div>
       </div>`;

  setPhase(1,'done');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 2 â€” 4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆç‹¬ç«‹åˆ†æï¼ˆçœŸã®ä¸¦åˆ—ãƒšãƒ«ã‚½ãƒŠï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function phase2() {
  setPhase(2,'active');
  setStatus('Phase 2: 4ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆãŒç‹¬ç«‹åˆ†æä¸­...', '');
  $('agents-card').style.display='block';
  ['ag-a','ag-b','ag-c','ag-d','st-a','st-b','st-c','st-d'].forEach(id=>{
    const e=$(id); if(e){ e.innerHTML=''; e.className = id.startsWith('ag') ? 'agent-body loading-dots' : 'agent-stance'; }
  });

  const raw = await callAPI(
    `ã‚ãªãŸã¯Webæ¤œç´¢æ©Ÿèƒ½ã‚’æŒã¤4äººã®ç‹¬ç«‹ã—ãŸå°‚é–€å®¶AIã§ã™ã€‚
å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯è‡ªèº«ã®å°‚é–€é ˜åŸŸã«é–¢é€£ã™ã‚‹æœ€æ–°æƒ…å ±ã‚’Webæ¤œç´¢ã—ã¦ã‹ã‚‰åˆ†æã—ã¾ã™ã€‚
JSONã®ã¿ã§å¿œç­”ã€‚ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯ãƒ»èª¬æ˜æ–‡ä¸€åˆ‡ä¸è¦ã€‚`,

    `ä»¥ä¸‹ã®å•ã„ã‚’ã€4ã¤ã®å°‚é–€å®¶ãƒšãƒ«ã‚½ãƒŠã§ãã‚Œãã‚Œåˆ†æã—ã¦ãã ã•ã„ã€‚
å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯å¿…ãšé–¢é€£ã™ã‚‹Webæ¤œç´¢ã‚’è¡Œã„ã€å®Ÿéš›ã®ãƒ‡ãƒ¼ã‚¿ãƒ»äº‹ä¾‹ãƒ»æ•°å€¤ã‚’ä½¿ã£ã¦åˆ†æã™ã‚‹ã“ã¨ã€‚

å…ƒã®å•ã„: ${$('q').value.trim()}
å†å®šç¾©: ${ST.decomp.reframed}
å¸‚å ´å®Ÿæ…‹: ${ST.decomp.market_reality}
ãƒœãƒˆãƒ«ãƒãƒƒã‚¯: ${ST.decomp.bottleneck}
Webæ¤œç´¢çµæœ: ${ST.decomp.web_findings}

å„ã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆã¯äº’ã„ã«çŸ›ç›¾ã™ã‚‹çµè«–ã‚’å‡ºã—ã¦ã‚ˆã„ã€‚ã€Œã€œãŒé‡è¦ã€ç­‰ã®æŠ½è±¡è¡¨ç¾ç¦æ­¢ã€‚å…·ä½“çš„ãªæ•°å€¤ãƒ»å›ºæœ‰åè©ãƒ»å› æœé–¢ä¿‚ã‚’å¿…ãšå«ã‚ã‚‹ã“ã¨ã€‚

{
  "alpha": {
    "analysis": "ç«¶äº‰æˆ¦ç•¥ãƒ»å¸‚å ´ãƒã‚¸ã‚·ãƒ§ãƒ‹ãƒ³ã‚°è¦–ç‚¹ã€‚æ¤œç´¢ã§å¾—ãŸç«¶åˆãƒ‡ãƒ¼ã‚¿ãƒ»å¸‚å ´è¦æ¨¡ãƒ»æˆåŠŸäº‹ä¾‹ã‚’ä½¿ã£ã¦åˆ†æï¼ˆ200å­—ä»¥ä¸Šï¼‰",
    "recommendation": "å…·ä½“çš„ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ•°å€¤ç›®æ¨™ãƒ»æœŸé™ãƒ»æ–¹æ³•ã‚’å«ã‚€ï¼‰",
    "confidence": 75,
    "stance": "GO/WAIT/NO-GOã®ã©ã‚Œã‹ + æ•°å€¤æ ¹æ‹ ã®ã‚ã‚‹ä¸€è¨€"
  },
  "beta": {
    "analysis": "å®Ÿè¡Œãƒ»ãƒªã‚½ãƒ¼ã‚¹ãƒ»ã‚³ã‚¹ãƒˆè¦–ç‚¹ã€‚æ¤œç´¢ã§å¾—ãŸå®Ÿéš›ã®ã‚³ã‚¹ãƒˆãƒ»å·¥æ•°ãƒ»ãƒ„ãƒ¼ãƒ«æƒ…å ±ã‚’ä½¿ã£ã¦åˆ†æï¼ˆ200å­—ä»¥ä¸Šï¼‰",
    "recommendation": "å…·ä½“çš„ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ•°å€¤ç›®æ¨™ãƒ»æœŸé™ãƒ»æ–¹æ³•ã‚’å«ã‚€ï¼‰",
    "confidence": 70,
    "stance": "GO/WAIT/NO-GOã®ã©ã‚Œã‹ + æ•°å€¤æ ¹æ‹ ã®ã‚ã‚‹ä¸€è¨€"
  },
  "gamma": {
    "analysis": "ãƒªã‚¹ã‚¯ãƒ»å¤±æ•—äº‹ä¾‹è¦–ç‚¹ã€‚æ¤œç´¢ã§å¾—ãŸå®Ÿéš›ã®å¤±æ•—ç‡ãƒ»è½ã¨ã—ç©´ãƒ»ç«¶åˆã®å¤±æ•—äº‹ä¾‹ã‚’ä½¿ã£ã¦åè«–ï¼ˆ200å­—ä»¥ä¸Šï¼‰",
    "recommendation": "å…·ä½“çš„ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ•°å€¤ç›®æ¨™ãƒ»æœŸé™ãƒ»æ–¹æ³•ã‚’å«ã‚€ï¼‰",
    "confidence": 60,
    "stance": "GO/WAIT/NO-GOã®ã©ã‚Œã‹ + æ•°å€¤æ ¹æ‹ ã®ã‚ã‚‹ä¸€è¨€"
  },
  "delta": {
    "analysis": "ç¬¬ä¸€åŸç†ãƒ»æ§‹é€ è¦–ç‚¹ã€‚ã€Œãªãœä»Šã“ã‚Œã‚’ã™ã‚‹ã®ã‹ã€ã‚’æ¤œç´¢ã§å¾—ãŸãƒˆãƒ¬ãƒ³ãƒ‰ãƒ‡ãƒ¼ã‚¿ã‹ã‚‰é€†ç®—ã—ã¦åˆ†æï¼ˆ200å­—ä»¥ä¸Šï¼‰",
    "recommendation": "å…·ä½“çš„ãªæ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆæ•°å€¤ç›®æ¨™ãƒ»æœŸé™ãƒ»æ–¹æ³•ã‚’å«ã‚€ï¼‰",
    "confidence": 65,
    "stance": "GO/WAIT/NO-GOã®ã©ã‚Œã‹ + æ•°å€¤æ ¹æ‹ ã®ã‚ã‚‹ä¸€è¨€"
  }
}`
  );

  const j = safeJSON(raw);
  if(!j?.alpha?.analysis) throw new Error('Phase2 ãƒ‘ãƒ¼ã‚¹å¤±æ•—: '+raw.slice(0,200));
  ST.agents = j;

  ['alpha','beta','gamma','delta'].forEach((key,i)=>{
    const ids = ['a','b','c','d'];
    const id  = ids[i];
    const ag  = j[key];
    if(!ag) return;
    $('ag-'+id).className='agent-body';
    $('ag-'+id).textContent = ag.analysis || '';
    $('st-'+id).textContent = `æ¨å¥¨: ${ag.recommendation||''}\nåˆ¤æ–­: ${ag.stance||''} (ç¢ºä¿¡åº¦ ${ag.confidence||'?'}%)`;
  });

  setPhase(2,'done');
}

/* â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
   PHASE 3 â€” Î© çµ±åˆãƒ»æœ€çµ‚æ±ºæ–­ï¼ˆã‚¨ãƒ¼ã‚¸ã‚§ãƒ³ãƒˆé–“ã®å¯¾ç«‹ã‚’çµ±åˆï¼‰
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• */
async function phase3()
